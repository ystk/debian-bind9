From: Markus Koschany <apo@debian.org>
Date: Mon, 1 Nov 2021 14:29:58 +0100
Subject: CVE-2021-25219

Origin: https://gitlab.isc.org/isc-projects/bind9/commit/8fe18c0566c41228a568157287f5a44f96d37662
Origin: https://gitlab.isc.org/isc-projects/bind9/commit/e4931584a34bdd0a0d18e4d918fb853bf5296787
---
 bin/named/config.c |  2 +-
 bin/named/server.c |  8 ++++++--
 lib/dns/resolver.c | 18 ++++++++++--------
 3 files changed, 17 insertions(+), 11 deletions(-)

diff --git a/bin/named/config.c b/bin/named/config.c
index 75a05ea..0a36981 100644
--- a/bin/named/config.c
+++ b/bin/named/config.c
@@ -149,7 +149,7 @@ options {\n\
 	notify-source-v6 *;\n\
 	cleaning-interval 0;  /* now meaningless */\n\
 	min-roots 2;\n\
-	lame-ttl 600;\n\
+	lame-ttl 0;\n\
 	max-ncache-ttl 10800; /* 3 hours */\n\
 	max-cache-ttl 604800; /* 1 week */\n\
 	min-ncache-ttl 0; /* 0 hours */\n\
diff --git a/bin/named/server.c b/bin/named/server.c
index 7093c8b..dcdbc44 100644
--- a/bin/named/server.c
+++ b/bin/named/server.c
@@ -3142,8 +3142,12 @@ configure_view(dns_view_t *view, dns_viewlist_t *viewlist,
 	result = ns_config_get(maps, "lame-ttl", &obj);
 	INSIST(result == ISC_R_SUCCESS);
 	lame_ttl = cfg_obj_asuint32(obj);
-	if (lame_ttl > 1800)
-		lame_ttl = 1800;
+	if (lame_ttl > 0) {
+		cfg_obj_log(obj, ns_g_lctx, ISC_LOG_WARNING,
+			    "disabling lame cache despite lame-ttl > 0 as it "
+			    "may cause performance issues");
+		lame_ttl = 0;
+	}
 	dns_resolver_setlamettl(view->resolver, lame_ttl);
 
 	/*
diff --git a/lib/dns/resolver.c b/lib/dns/resolver.c
index ac8d773..eb2df69 100644
--- a/lib/dns/resolver.c
+++ b/lib/dns/resolver.c
@@ -7184,18 +7184,20 @@ resquery_response(isc_task_t *task, isc_event_t *event) {
 	/*
 	 * Is the server lame?
 	 */
-	if (fctx->res->lame_ttl != 0 && !ISFORWARDER(query->addrinfo) &&
-	    is_lame(fctx)) {
+	if (!ISFORWARDER(query->addrinfo) && is_lame(fctx)) {
 		inc_stats(fctx->res, dns_resstatscounter_lame);
 		log_lame(fctx, query->addrinfo);
-		result = dns_adb_marklame(fctx->adb, query->addrinfo,
-					  &fctx->name, fctx->type,
-					  now + fctx->res->lame_ttl);
-		if (result != ISC_R_SUCCESS)
-			isc_log_write(dns_lctx, DNS_LOGCATEGORY_RESOLVER,
-				      DNS_LOGMODULE_RESOLVER, ISC_LOG_ERROR,
-				      "could not mark server as lame: %s",
-				      isc_result_totext(result));
+		if (fctx->res->lame_ttl != 0) {
+				result = dns_adb_marklame(fctx->adb, query->addrinfo,
+				  &fctx->name, fctx->type,
+				  now + fctx->res->lame_ttl);
+				if (result != ISC_R_SUCCESS) {
+					isc_log_write(dns_lctx, DNS_LOGCATEGORY_RESOLVER,
+						  DNS_LOGMODULE_RESOLVER, ISC_LOG_ERROR,
+						"could not mark server as lame: %s",
+						isc_result_totext(result));
+				}
+		}
 		broken_server = DNS_R_LAME;
 		keep_trying = ISC_TRUE;
 		goto done;
